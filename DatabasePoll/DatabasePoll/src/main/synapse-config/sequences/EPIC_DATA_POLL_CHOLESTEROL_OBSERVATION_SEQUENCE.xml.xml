<?xml version="1.0" encoding="UTF-8"?>
<sequence name="EPIC_DATA_POLL_CHOLESTEROL_OBSERVATION_SEQUENCE" trace="disable" xmlns="http://ws.apache.org/ns/synapse">
    <log level="custom">
        <property name="Start" value="Request Send"/>
    </log>
    <header name="Accept" scope="transport" value="application/json"/>
    <call>
        <endpoint>
            <http method="get" uri-template="http://localhost:8283/services/RDBMSDataService/allpatients"/>
        </endpoint>
    </call>
    <iterate expression="//Patients/Patient">
        <target>
            <sequence>
                <property description="ID" expression="//patientId" name="uri.var.id" scope="default" type="STRING"/>
                <call>
                    <endpoint>
                        <http method="get" uri-template="https://open-ic.epic.com/FHIR/api/FHIR/DSTU2/Observation?patient={uri.var.id}&amp;code=2093-3"/>
                    </endpoint>
                </call>
                <property description="To" expression="json-eval($.entry[0].resource.issue[0].details.coding[0].code)" name="uri.var.issue" scope="default" type="STRING"/>
                <log level="custom">
                    <property expression="get-property('uri.var.issue')" name="Issue"/>
                </log>
                <filter description="" regex="4101" source="get-property('uri.var.issue')">
                    <then>
                        <log level="custom">
                            <property name="EPIC_ERROR_CODE" value="4101"/>
                        </log>
                        <drop/>
                    </then>
                    <else>
                        <log level="custom">
                            <property expression="json-eval($.)" name="Log"/>
                        </log>
                        <kafkaTransport.init>
                            <bootstrapServers>localhost:9092</bootstrapServers>
                            <keySerializerClass>org.apache.kafka.common.serialization.StringSerializer</keySerializerClass>
                            <valueSerializerClass>org.apache.kafka.common.serialization.StringSerializer</valueSerializerClass>
                        </kafkaTransport.init>
                        <kafkaTransport.publishMessages>
                            <topic>cholesterol-epic</topic>
                            <message>HelloKakfa</message>
                            <partitionNo>0</partitionNo>
                        </kafkaTransport.publishMessages>
                    </else>
                </filter>
            </sequence>
        </target>
    </iterate>
    <respond/>
</sequence>
